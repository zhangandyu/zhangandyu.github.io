<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="技能-Hive-SQL学习, Hexo">
    <meta name="description" content="HIVE从入门到进阶">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>技能-Hive-SQL学习 | Hexo</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hexo</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hexo</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://brandgenetics.com/wp-content/uploads/2020/03/Hive-banner_26032020_revised-with-safe-space_option-2--1100x400.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">技能-Hive-SQL学习</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/SQL/">
                                <span class="chip bg-color">SQL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SQL/" class="post-category">
                                SQL
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2020-06-02
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="SQL中的简单查询"><a href="#SQL中的简单查询" class="headerlink" title="SQL中的简单查询"></a>SQL中的简单查询</h2><p>表：score_student</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>class</th>
<th>age</th>
<th>score</th>
</tr>
</thead>
<tbody><tr>
<td>01</td>
<td>甲</td>
<td>一班</td>
<td>18</td>
<td>{“语文”:89,”数学”:98,”英语”:76}</td>
</tr>
<tr>
<td>02</td>
<td>乙</td>
<td>一班</td>
<td>19</td>
<td>{“语文”:96,”数学”:52,”英语”:78}</td>
</tr>
<tr>
<td>03</td>
<td>丙</td>
<td>二班</td>
<td>21</td>
<td>{“语文”:76,”数学”:69,”英语”:89}</td>
</tr>
<tr>
<td>04</td>
<td>丁</td>
<td>二班</td>
<td>23</td>
<td>{“语文”:92,”数学”:91,”英语”:96}</td>
</tr>
<tr>
<td>05</td>
<td>张</td>
<td>三班</td>
<td>25</td>
<td>{“语文”:85,”数学”:90,”英语”:73}</td>
</tr>
</tbody></table>
<ol>
<li><p>获取指定的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    id,</span><br><span class="line">    name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    class <span class="operator">=</span> <span class="string">&#x27;一班&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>插入一列固定值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    name,</span><br><span class="line">    &quot;age &lt; 20 &quot; <span class="keyword">as</span> label</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    age <span class="operator">&lt;</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>label</th>
</tr>
</thead>
<tbody><tr>
<td>01</td>
<td>甲</td>
<td>age &lt; 20</td>
</tr>
<tr>
<td>02</td>
<td>乙</td>
<td>age &lt; 20</td>
</tr>
</tbody></table>
</li>
<li><p>json解析-获取对应的value值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    name,</span><br><span class="line">    json_extract(score, <span class="string">&#x27;$.英语&#x27;</span>) <span class="keyword">as</span> <span class="string">&#x27;英语成绩&#x27;</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>name</th>
<th>英语成绩</th>
</tr>
</thead>
<tbody><tr>
<td>甲</td>
<td>76</td>
</tr>
<tr>
<td>乙</td>
<td>78</td>
</tr>
<tr>
<td>丙</td>
<td>89</td>
</tr>
<tr>
<td>张</td>
<td>73</td>
</tr>
</tbody></table>
</li>
<li><p>json解析-查看key值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    name,</span><br><span class="line">    json_keys(score) <span class="keyword">as</span> <span class="string">&#x27;科目&#x27;</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>name</th>
<th>科目</th>
</tr>
</thead>
<tbody><tr>
<td>甲</td>
<td>[“语文”,”数学”,”英语”]</td>
</tr>
<tr>
<td>乙</td>
<td>[“语文”,”数学”,”英语”]</td>
</tr>
<tr>
<td>丙</td>
<td>[“语文”,”数学”,”英语”]</td>
</tr>
<tr>
<td>张</td>
<td>[“语文”,”数学”,”英语”]</td>
</tr>
</tbody></table>
</li>
</ol>
<ol start="5">
<li>加入表中一列含有多个元素， 我们可以只查找此列的第一个元素<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    name[<span class="number">0</span>] </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    employees</span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="6">
<li>可以使用 “点” 符号， 如：表的别名.列名<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  </span><br><span class="line">    name, </span><br><span class="line">    address.city  </span><br><span class="line"><span class="keyword">from</span>  </span><br><span class="line">    employees</span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="7">
<li><p>使用正则表达式，可以选出所有列名以 price 作为前缀的列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="string">&#x27;price.*&#x27;</span>  </span><br><span class="line"><span class="keyword">from</span>  </span><br><span class="line">    stocks</span><br></pre></td></tr></table></figure></li>
<li><p>where中关系型运算符优先级高到低为：not - and - or</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    employees </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    country  <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;us&#x27;</span>, <span class="string">&#x27;china&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>where中用like、rlike进行数据筛选</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    name, </span><br><span class="line">    address.street </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    employees </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    address.street rlike <span class="string">&#x27;.*(beijing|shanghai).*&#x27;</span></span><br><span class="line">    <span class="comment">--address.street like &#x27;%beijing%&#x27; </span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>like与rlike中常见的通配符</li>
</ul>
<table>
<thead>
<tr>
<th>like通配符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>%</td>
<td>匹配0个或任意多个字符</td>
</tr>
<tr>
<td>_</td>
<td>匹配任意一个字符</td>
</tr>
<tr>
<td>escape</td>
<td>转义字符，可匹配%和_。如SELECT * FROM table_name WHERE column_name LIKE ‘/%/<em>%</em>‘ ESCAPE’/‘</td>
</tr>
<tr>
<td>——</td>
<td>————————————————————</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>rlike通配符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>.</td>
<td>匹配任意单个字 符</td>
</tr>
<tr>
<td>*</td>
<td>匹配0个或多个前一个得到的字符</td>
</tr>
<tr>
<td>[]</td>
<td>含有任意一个[]内的字符，[ab]*可匹配空串、a、b、或者由任意个a和b组成的字符串</td>
</tr>
<tr>
<td>^</td>
<td>匹配开头，如^s匹配以s或者S开头的字符串</td>
</tr>
<tr>
<td>$</td>
<td>匹配结尾，如s$匹配以s结尾的字符串</td>
</tr>
<tr>
<td>{n}</td>
<td>匹配前一个字符反复n次</td>
</tr>
</tbody></table>
<ol start="10">
<li>对数据进行排序——order by<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    a </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">    code <span class="keyword">asc</span>, name <span class="keyword">desc</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>排序说明</li>
</ul>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>order by a,b</td>
<td>a和b都是升序</td>
</tr>
<tr>
<td>order by a,b desc</td>
<td>a升序，b降序</td>
</tr>
<tr>
<td>order by a desc，b</td>
<td>a降序，b升序</td>
</tr>
<tr>
<td>order by a desc，b desc</td>
<td>a，b都是降序</td>
</tr>
</tbody></table>
<ol start="11">
<li><p>对数据进行限制-limit</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    account</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    employees</span><br><span class="line">limit <span class="number">10</span> <span class="comment">---使用limit语句限制返回的行数，只显示 10 行</span></span><br><span class="line">limit <span class="number">2</span>,<span class="number">3</span><span class="comment">--获取第2行（不包含第2行），以后的3行数据</span></span><br></pre></td></tr></table></figure></li>
<li><p>注释</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">大段文字注释</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">select</span></span><br><span class="line"><span class="comment">    account</span></span><br><span class="line"><span class="comment">from </span></span><br><span class="line"><span class="comment">    employees</span></span><br><span class="line"><span class="comment">limit 10 ---使用limit语句限制返回的行数，只显示 10 行， 对某一行进行注释</span></span><br><span class="line"><span class="comment">limit 2,3--获取第2行（不包含第2行），以后的3行数据</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h2><ol>
<li>排除缺失值<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    score <span class="operator">!=</span> &quot;&quot; <span class="keyword">or</span> </span><br><span class="line">    score <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">or</span> </span><br><span class="line">    score <span class="operator">!=</span> &quot; &quot;</span><br></pre></td></tr></table></figure></li>
<li>缺失值填充<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    <span class="built_in">coalesce</span>(score, <span class="number">1</span>),<span class="comment">--当score为null值时，将返回1，否则返回score真实值</span></span><br><span class="line">    <span class="built_in">coalesce</span>( name, score,<span class="number">1</span>)<span class="comment">--当name不为null，那么无论score是否为null，都返回name的真实值。当name为null,而score不为null时，返回score的真实值。当name和score都为null时，返回1</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    if(score<span class="operator">!=</span> &quot;&quot;, score, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>重复值处理<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  </span><br><span class="line">    <span class="keyword">distinct</span> user_account,<span class="comment">--如果用 distinct, select 后面必须直接跟 distinct</span></span><br><span class="line">    province </span><br><span class="line"><span class="keyword">from</span>    </span><br><span class="line">    computer</span><br></pre></td></tr></table></figure></li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    user_account,</span><br><span class="line">    province</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    computer</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    user_account,</span><br><span class="line">    province</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>数据格式转换-cast与convert函数<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    age,</span><br><span class="line">    <span class="built_in">cast</span>(age <span class="keyword">as</span> <span class="type">decimal</span>) <span class="keyword">as</span> decimal_age,</span><br><span class="line">    <span class="keyword">convert</span>(age <span class="keyword">as</span> <span class="type">char</span>) <span class="keyword">as</span> char_age</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>数据类型</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>符号</th>
</tr>
</thead>
<tbody><tr>
<td>浮点型</td>
<td>decimal</td>
</tr>
<tr>
<td>整形</td>
<td>signed</td>
</tr>
<tr>
<td>字符型</td>
<td>char</td>
</tr>
<tr>
<td>二进制</td>
<td>binary</td>
</tr>
<tr>
<td>日期</td>
<td>date</td>
</tr>
<tr>
<td>时间</td>
<td>time</td>
</tr>
<tr>
<td>日期时间</td>
<td>datetime</td>
</tr>
</tbody></table>
<h2 id="数据运算"><a href="#数据运算" class="headerlink" title="数据运算"></a>数据运算</h2><ol>
<li>算数运算<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    (score_a <span class="operator">+</span> score_b) <span class="keyword">as</span> all_score</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>算数运算符</li>
</ul>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>加法</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
</tr>
<tr>
<td>/</td>
<td>除法</td>
</tr>
<tr>
<td>% , mod</td>
<td>取余</td>
</tr>
<tr>
<td>div</td>
<td>整除</td>
</tr>
</tbody></table>
<ol start="2">
<li>比较运算<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    score_a,</span><br><span class="line">    score_b,</span><br><span class="line">    score_a <span class="operator">&gt;</span> score_b <span class="keyword">as</span> <span class="string">&#x27;大于&#x27;</span> <span class="comment">--返回1或0</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>比较运算符</li>
</ul>
<table>
<thead>
<tr>
<th><strong>操作符</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>&lt;&gt; , !=</td>
<td>不等于</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于或等于</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于或等于</td>
</tr>
<tr>
<td>[not] between</td>
<td>介于</td>
</tr>
<tr>
<td>in</td>
<td>包含</td>
</tr>
<tr>
<td>is [not] null</td>
<td>空值</td>
</tr>
</tbody></table>
<ol start="3">
<li>逻辑运算<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    id,</span><br><span class="line">    score_a,</span><br><span class="line">    score_b,</span><br><span class="line">    ((score_a <span class="operator">&gt;</span><span class="number">85</span>) <span class="keyword">and</span> ( score_b <span class="operator">&gt;</span> <span class="number">85</span>)) <span class="keyword">as</span> &quot;双优&quot;,</span><br><span class="line">    ((score_a <span class="operator">&gt;</span><span class="number">85</span>) <span class="keyword">or</span> ( score_b <span class="operator">&gt;</span> <span class="number">85</span>)) <span class="keyword">as</span> &quot;单优&quot;</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>逻辑运算符</li>
</ul>
<table>
<thead>
<tr>
<th><strong>逻辑符</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>and</td>
<td>和</td>
</tr>
<tr>
<td>or</td>
<td>或</td>
</tr>
<tr>
<td>not</td>
<td>非</td>
</tr>
</tbody></table>
<ol start="4">
<li>数学运算<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    id,</span><br><span class="line">    score_a,</span><br><span class="line">    score_b,</span><br><span class="line">    <span class="built_in">abs</span>(score_a <span class="operator">-</span>core_b ) <span class="keyword">as</span> &quot;绝对差值&quot;,</span><br><span class="line">    sign(score_a <span class="operator">-</span>core_b ) <span class="keyword">as</span> &quot;正负&quot;</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>数学运算符</li>
</ul>
<table>
<thead>
<tr>
<th><strong>数学函数</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>abs(x)</td>
<td>返回x的绝对值</td>
</tr>
<tr>
<td>ceil(x)</td>
<td>返回不小于x的最小整数值</td>
</tr>
<tr>
<td>floor(x)</td>
<td>返回不大于x的最大整数值</td>
</tr>
<tr>
<td>rand()</td>
<td>返回一个随机浮点值</td>
</tr>
<tr>
<td>round(d,x)</td>
<td>返回d精确度的x</td>
</tr>
<tr>
<td>sign(x)</td>
<td>返回x的正负，如果为正返回1，为负返回-1</td>
</tr>
</tbody></table>
<ol start="5">
<li>聚合运算<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="built_in">sum</span>(score_a) <span class="keyword">as</span> a_sum,</span><br><span class="line">    <span class="built_in">sum</span>(score_b) <span class="keyword">as</span> b_sum,</span><br><span class="line">    <span class="built_in">sum</span>(a_sum) <span class="operator">+</span> <span class="built_in">sum</span>(b_sum) <span class="keyword">as</span> a_b_sum</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    score_student</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>聚合函数</li>
</ul>
<table>
<thead>
<tr>
<th>聚合函数</th>
<th>定义</th>
</tr>
</thead>
<tbody><tr>
<td>count()</td>
<td>个数统计函数</td>
</tr>
<tr>
<td>sum()</td>
<td>求和</td>
</tr>
<tr>
<td>avg()</td>
<td>平均值</td>
</tr>
<tr>
<td>min()</td>
<td>最小值</td>
</tr>
<tr>
<td>max()</td>
<td>最大值</td>
</tr>
<tr>
<td>corr(A, B)</td>
<td>相关系数</td>
</tr>
<tr>
<td>var_pop()</td>
<td>总体方差</td>
</tr>
<tr>
<td>var_samp()</td>
<td>样本方差</td>
</tr>
<tr>
<td>std()</td>
<td>总体标准差</td>
</tr>
<tr>
<td>stddev_samp</td>
<td>样本标准差</td>
</tr>
</tbody></table>
<ul>
<li>count(1)、count(*)、count(column) 之间的区别<blockquote>
<p>执行范围上： count(*) 和 count (1)  都包含了 对NULL的统计。 count(列名)统计时不包含NULL值。<br>执行速度上： 列名为主键时， count(列名) 最快。  当无主键时， count(1) 最快。  当表只有一个字段，count(*) 最快。</p>
</blockquote>
</li>
</ul>
<h2 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a>字符串处理</h2><ol>
<li>字符串函数</li>
</ol>
<table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody><tr>
<td>concat(str1, str2,..strn)</td>
<td>将str1,str2,…strn合并成一个字符串,只要其中一个是NUll，则返回NUll</td>
</tr>
<tr>
<td>concat_ws(s,str1, str2,…strn)</td>
<td>将str1,str2,…strn用连接符s合并成一个字符串,只能接收 string或string类型的数组，只要有一个字符串</td>
</tr>
<tr>
<td>collect_set(col)</td>
<td>将某字段的值进行去重汇总，产生array类型字段</td>
</tr>
<tr>
<td>collect_list(col)</td>
<td>将某字段的值进行汇总不去重，产生array类型字段</td>
</tr>
<tr>
<td>explode(col)</td>
<td>将hive列中复杂的array或者map结构拆分成多行</td>
</tr>
<tr>
<td>substr / substring(str,m,n)</td>
<td>获取字符串str从m位置开始，长度为n的字符串</td>
</tr>
<tr>
<td>split(str, s)</td>
<td>str字符串通过s进行分割</td>
</tr>
<tr>
<td>substring_index(str, s,n)</td>
<td>str字符串通过第n个s进行分割</td>
</tr>
<tr>
<td>replace(str,a,b)</td>
<td>将str字符串中的a替换成b</td>
</tr>
<tr>
<td>left(str, n)</td>
<td>取str字符串中最左边的n个字符</td>
</tr>
<tr>
<td>right(str,n)</td>
<td>取str字符串中最右边的n个字符</td>
</tr>
<tr>
<td>ltrim(str)</td>
<td>去除str字符串左边的空格</td>
</tr>
<tr>
<td>rtrim(str)</td>
<td>去除str字符串右边的空格</td>
</tr>
<tr>
<td><strong>trim(str)</strong></td>
<td>去除str字符串开头和结尾的空格</td>
</tr>
<tr>
<td>length / char_length(str)</td>
<td>返回str字符串的字符长度，一个汉字算三个字符</td>
</tr>
<tr>
<td>repeat(str,n)</td>
<td>将str字符串重复n遍</td>
</tr>
<tr>
<td>lower()</td>
<td>将字串转化为小写</td>
</tr>
<tr>
<td>upper()</td>
<td>将字符转化为大写</td>
</tr>
<tr>
<td>lpad(str1，n，str2)</td>
<td>在str1字符串的左边第n个位置，添加str2</td>
</tr>
<tr>
<td>rpad(str1，n，str2)</td>
<td>在str1字符串的右边第n个位置，添加str2</td>
</tr>
<tr>
<td>instr (A ,B )</td>
<td>返回字符B首次在A中出现的位置,不存在返回0</td>
</tr>
</tbody></table>
<ol start="2">
<li><p><strong>substr函数与 substring函数用法</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">substr(string,<span class="number">4</span>): 从右第<span class="number">4</span>位置截取到最后，结果为：ing</span><br><span class="line"><span class="built_in">substring</span>(string,<span class="number">1</span>,<span class="number">3</span>):取左边第<span class="number">1</span>位置起，<span class="number">3</span>字长的字符串，结果为：str</span><br><span class="line"><span class="built_in">substring</span>(string,<span class="number">-3</span>,<span class="number">3</span>):取右边第<span class="number">1</span>位置起，<span class="number">3</span>字长的字符串,右边第一位置往右不够<span class="number">3</span>字长，结果为：g</span><br><span class="line"><span class="built_in">substring</span>(string,<span class="number">-3</span>,<span class="number">3</span>):取右边第<span class="number">1</span>位置起，<span class="number">3</span>字长的字符串，结果为：ing</span><br></pre></td></tr></table></figure></li>
<li><p><strong>substring_index函数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">substring_index(<span class="string">&#x27;15,151,152,16&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="number">1</span>)：取第一个逗号前面的字符串，结果为：<span class="number">15</span></span><br><span class="line">substring_index(<span class="string">&#x27;15,151,152,16&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>)：取第二个逗号前面部分，结果为：<span class="number">15</span>,<span class="number">151</span></span><br><span class="line">substring_index(<span class="string">&#x27;15,151,152,16&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="number">-1</span>)：取目标字符串中最后一个含 “,” 位子的后的部分，结果为：<span class="number">16</span></span><br><span class="line">substring_index(substring_index(<span class="string">&#x27;15,151,152,16&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>),<span class="string">&#x27;,&#x27;</span>,<span class="number">-1</span>):取第二个逗号前面部分,然后最后逗号的前面部分，结果为：<span class="number">151</span></span><br><span class="line">substring_index(substring_index(<span class="string">&#x27;15,151,152,16&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="number">-2</span>),<span class="string">&#x27;,&#x27;</span>,<span class="number">1</span>)：取倒数第二个逗号后面部分字符串，再去这部分里第一个都号前的部分，结果为：<span class="number">152</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>split函数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">split(<span class="string">&#x27;a,b,c,d&#x27;</span>,<span class="string">&#x27;,&#x27;</span>):根据逗号进行分割，结果为： [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;]</span><br><span class="line">split(<span class="string">&#x27;a,b,c,d&#x27;</span>,<span class="string">&#x27;,&#x27;</span>)[<span class="number">0</span>]： 取结果数组中的某一项，结果为： a</span><br><span class="line">split(<span class="string">&#x27;192.168.0.1&#x27;</span>,<span class="string">&#x27;\\.&#x27;</span>)： 点号这种特殊字符的时候需要做特殊的处理，结果为：[&quot;192&quot;,&quot;168&quot;,&quot;0&quot;,&quot;1&quot;]</span><br><span class="line">&quot;....  split(&#x27;192.168.0.1&#x27;,&#x27;\\\\.&#x27;) ... &quot;: split包含在 &quot;&quot; 之中时 需要加<span class="number">4</span>个\,不然得到的值是<span class="keyword">null</span>,同样的 <span class="operator">|</span> 等特殊符号也需要做类似处理。</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>例如： 将一些字段拆解出来进行使用<blockquote>
<p>比如：Syjh-sjsy-zygn-3_1字段，我们只需要Syjh-sjsy-zygn位置的所有按钮。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    substring_index(nbtn_position, <span class="string">&#x27;-&#x27;</span>,<span class="number">3</span>) <span class="keyword">as</span> position,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    apache_computer_view</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="operator">=</span> <span class="string">&#x27;2020-03-01&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    nbtn_position <span class="keyword">like</span> <span class="string">&#x27;%Syjh%&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    substring_index(nbtn_position, <span class="string">&#x27;-&#x27;</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="5">
<li><strong>lpad(str1,len,str2)</strong> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	lpad(nbtn_name, <span class="number">7</span>, <span class="string">&#x27;xo&#x27;</span>) <span class="keyword">as</span> <span class="string">&#x27;左填充&#x27;</span>,</span><br><span class="line">	rpad(nbtn_name, <span class="number">7</span>, <span class="string">&#x27;xo&#x27;</span>) <span class="keyword">as</span> <span class="string">&#x27;右填充&#x27;</span>,</span><br><span class="line">	nbtn_name <span class="keyword">as</span> <span class="string">&#x27;不填充&#x27;</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table1</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>左填充</th>
<th>右填充</th>
<th>不填充</th>
</tr>
</thead>
<tbody><tr>
<td>xoxo张晓东</td>
<td>张晓东xoxo</td>
<td>张晓东</td>
</tr>
</tbody></table>
</li>
</ol>
<ol start="6">
<li><strong>concat_ws函数</strong> <blockquote>
<p>把下表中星座和血型一样的人归类到一起：</p>
</blockquote>
</li>
</ol>
<table>
<thead>
<tr>
<th>name</th>
<th>contellation</th>
<th>blood_type</th>
</tr>
</thead>
<tbody><tr>
<td>孙悟空</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>猪八戒</td>
<td>射手座</td>
<td>A</td>
</tr>
<tr>
<td>宋宋</td>
<td>白羊座</td>
<td>B</td>
</tr>
<tr>
<td>唐僧</td>
<td>白羊座</td>
<td>A</td>
</tr>
<tr>
<td>张帅</td>
<td>射手座</td>
<td>A</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">con_blood,</span><br><span class="line">concat_ws (&quot;\&quot;, collect_set(name))</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">SELECT</span> </span><br><span class="line">concat_ws( <span class="string">&#x27;,&#x27;</span>, contellation, blood_type) <span class="keyword">as</span> con_blood,</span><br><span class="line">name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">table1) </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">con_blood</span><br></pre></td></tr></table></figure>
<blockquote>
<p>得到结果如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>con_blod</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>射手座,A</td>
<td>猪八戒\张帅</td>
</tr>
<tr>
<td>白羊座，A</td>
<td>孙悟空\唐僧</td>
</tr>
<tr>
<td>白羊座，B</td>
<td>宋</td>
</tr>
</tbody></table>
<ol start="7">
<li><strong>collect_set函数</strong> </li>
</ol>
<blockquote>
<p>求将每个省的城市列出来<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">province, </span><br><span class="line">collect_set(city) </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">android </span><br><span class="line"><span class="keyword">where</span>  dt <span class="operator">=</span> <span class="string">&#x27;2020-05-01&#x27;</span> <span class="keyword">and</span> city <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">province <span class="comment">---辽宁省  [&quot;营口市&quot;,&quot;大连&quot;,&quot;大连市&quot;,.....,&quot;朝阳&quot;]</span></span><br></pre></td></tr></table></figure><br>求出一个月内活跃天数大于20天的用户数<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> </span><br><span class="line">user_account,</span><br><span class="line">collect_set(hit_date)  <span class="keyword">as</span> dt</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">an</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-05-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-05-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">user_account</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">size(dt) <span class="operator">&gt;</span> <span class="number">20</span>)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol start="8">
<li><strong>explode函数</strong>  </li>
</ol>
<ul>
<li><p>函数说明</p>
<blockquote>
<ul>
<li>explode(col): 将hive列中复杂的array或者map结构拆分成多行</li>
<li><strong>lateral view</strong> 用法： lateral view UDTF(expression) adtable  as a1  说明： 用户和split,explode 等UDTF一起使用，能够将一列数据拆分成多行数据， 在此基础上可以对拆分的数据进行聚合计算. 形成一个新的表，并对原来的表进行侧写</li>
</ul>
</blockquote>
</li>
<li><p>需求1：</p>
<blockquote>
<p>将如下表进行拆分</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody><tr>
<td>《疑犯追踪》</td>
<td>悬疑,动作,科幻,剧情</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>警匪,动作,心理</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	movie. categrory_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">movie_info</span><br><span class="line"><span class="keyword">lateral</span>  <span class="keyword">view</span> explode ( categrory)  adtable <span class="keyword">as</span> categrory_name</span><br></pre></td></tr></table></figure>
<blockquote>
<p>得到结果如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody><tr>
<td>《疑犯追踪》</td>
<td>悬疑</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>动作</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>科幻</td>
</tr>
<tr>
<td>《疑犯追踪》</td>
<td>剧情</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>警匪</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>动作</td>
</tr>
<tr>
<td>《lie to me》</td>
<td>心理</td>
</tr>
</tbody></table>
<ul>
<li>需求2： <blockquote>
<p>将 表 table 中的 <code>adid_list</code> 转换为单独的行。</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>pageid</th>
<th>adid_list</th>
</tr>
</thead>
<tbody><tr>
<td>front_page</td>
<td>[1,2,3]</td>
</tr>
<tr>
<td>contact_page</td>
<td>[3,4]</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	pageid, adid</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	talbe1</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(adid_list) adtable <span class="keyword">as</span> adid</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果为： </p>
</blockquote>
<table>
<thead>
<tr>
<th>pageid</th>
<th>adid_list</th>
</tr>
</thead>
<tbody><tr>
<td>front_page</td>
<td>1</td>
</tr>
<tr>
<td>front_page</td>
<td>2</td>
</tr>
<tr>
<td>front_page</td>
<td>3</td>
</tr>
<tr>
<td>contact_page</td>
<td>3</td>
</tr>
<tr>
<td>contact_page</td>
<td>4</td>
</tr>
</tbody></table>
<ul>
<li>需求3： <blockquote>
<p>多个 lateral view 查询</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>array</th>
<th>col2</th>
</tr>
</thead>
<tbody><tr>
<td>[1,2]</td>
<td>[“a”，”b”]</td>
</tr>
<tr>
<td>[3,4]</td>
<td>[“c”, “d”]</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	mycol1,</span><br><span class="line">	mycol2</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table1</span><br><span class="line">alteral  <span class="keyword">view</span> explode(<span class="keyword">array</span>) adtable <span class="keyword">as</span> mycol1 </span><br><span class="line">alteral  <span class="keyword">view</span> explode(col2)  adtable <span class="keyword">as</span> mycol2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果为： </p>
</blockquote>
<table>
<thead>
<tr>
<th>myCol1</th>
<th>myCol2</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>“a”</td>
</tr>
<tr>
<td>1</td>
<td>“b”</td>
</tr>
<tr>
<td>2</td>
<td>“a”</td>
</tr>
<tr>
<td>2</td>
<td>“b”</td>
</tr>
<tr>
<td>3</td>
<td>“c”</td>
</tr>
<tr>
<td>3</td>
<td>“d”</td>
</tr>
<tr>
<td>4</td>
<td>“c”</td>
</tr>
<tr>
<td>4</td>
<td>“d”</td>
</tr>
</tbody></table>
<hr>
<h2 id="控制函数"><a href="#控制函数" class="headerlink" title="控制函数"></a>控制函数</h2><ol>
<li><p><strong>IF( expr , v1 , v2 )函数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="operator">*</span> </span><br><span class="line">     if(age<span class="operator">&lt;</span><span class="number">20</span>,<span class="string">&#x27;少年&#x27;</span>,<span class="string">&#x27;青年&#x27;</span>) <span class="keyword">AS</span> ifage <span class="comment">--- 查出班级所有学生，如果年龄小于20，就标准为少年，否则标记为青年。</span></span><br><span class="line"><span class="keyword">from</span>  </span><br><span class="line">    student</span><br></pre></td></tr></table></figure></li>
<li><p><strong>ifnull(V1,V2)函数</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    ifnull(<span class="number">1</span>,<span class="number">2</span>),<span class="comment">--如果v1不为空，则直接返回v1;如果v1为空，则返回参数v2</span></span><br><span class="line">    ifnull(<span class="keyword">null</span>,<span class="number">10</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><strong>case when 函数</strong></p>
</li>
</ol>
<ul>
<li>对不同字母进行省份转换<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line"><span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;ah&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;安徽&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;fj&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;福建&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;gd&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;广东&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">&#x27;m&#x27;</span> </span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> province ,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) uv,</span><br><span class="line">    <span class="built_in">count</span>(page_name) pv</span><br><span class="line"><span class="keyword">from</span> android_log</span><br><span class="line"><span class="keyword">where</span> hit_date <span class="keyword">between</span> <span class="string">&#x27;&#123;&#125;&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;&#123;&#125;&#x27;</span></span><br><span class="line"><span class="keyword">and</span> page_name <span class="keyword">like</span> <span class="string">&#x27;%Kefujh%&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;ah&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;安徽&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;fj&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;福建&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;gd&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;广东&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">&#x27;m&#x27;</span> </span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;ah&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;安徽&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;fj&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;福建&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> province <span class="keyword">like</span> <span class="string">&#x27;gd&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;广东&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">&#x27;m&#x27;</span> </span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line">limit <span class="number">1000</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>范围转换<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> population <span class="operator">&lt;</span> <span class="number">250</span> <span class="keyword">then</span> <span class="string">&#x27;1&#x27;</span> </span><br><span class="line">			<span class="keyword">when</span> population  <span class="operator">=</span> <span class="number">250</span> <span class="keyword">and</span>  population <span class="operator">&lt;</span> <span class="number">500</span> <span class="keyword">then</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span>  <span class="keyword">as</span> pop_class,</span><br><span class="line"><span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> cntfrom </span><br><span class="line"><span class="keyword">from</span> pop </span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="日期函数"><a href="#日期函数" class="headerlink" title="日期函数"></a>日期函数</h2><ol>
<li><strong>时间函数</strong></li>
</ol>
<table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody><tr>
<td>NOW()</td>
<td>当前时间</td>
</tr>
<tr>
<td>curdate()</td>
<td>获取当前时刻的日期</td>
</tr>
<tr>
<td>curtime()</td>
<td>获取当前时刻的时间</td>
</tr>
<tr>
<td>date()</td>
<td>返回时间的日期部分</td>
</tr>
<tr>
<td>year()</td>
<td>返回时间的年份</td>
</tr>
<tr>
<td>month()</td>
<td>返回时间的月份</td>
</tr>
<tr>
<td>day()</td>
<td>返回日期的天</td>
</tr>
<tr>
<td>hour()</td>
<td>返回时间的小时</td>
</tr>
<tr>
<td>minute()</td>
<td>返回时间的分钟</td>
</tr>
<tr>
<td>second()</td>
<td>返回时间的秒</td>
</tr>
<tr>
<td>week ()</td>
<td>第几周</td>
</tr>
<tr>
<td>time()</td>
<td>将日期转换为时间</td>
</tr>
<tr>
<td>dayofweek()</td>
<td>返回星期几，1为星期天</td>
</tr>
<tr>
<td>dayofyear()</td>
<td>一年中的第几天</td>
</tr>
<tr>
<td>weekofyear(now())</td>
<td>获取当前时间是全年的第几周</td>
</tr>
<tr>
<td>quarter()</td>
<td>获取时间所属的季度</td>
</tr>
<tr>
<td>sec_to_time ( )</td>
<td>秒数转成时间</td>
</tr>
<tr>
<td>date_add(dt,interval 1 day )</td>
<td>时间相加</td>
</tr>
<tr>
<td>date_sub(date,INTERVAL expr（时间间隔） type（时间类型，天、月、年）)</td>
<td>时间相减</td>
</tr>
<tr>
<td>datediff()</td>
<td>时间的差值</td>
</tr>
<tr>
<td>extract()</td>
<td>抽取具体的年、月、日</td>
</tr>
<tr>
<td>date_format()</td>
<td>输出指定时间格式</td>
</tr>
</tbody></table>
<ol start="2">
<li> <strong>extract(unit from datetime)用法</strong></li>
</ol>
<ul>
<li>unit的取值说明为：</li>
</ul>
<table>
<thead>
<tr>
<th>unit</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>year</td>
<td>年</td>
</tr>
<tr>
<td>month</td>
<td>月</td>
</tr>
<tr>
<td>day</td>
<td>日</td>
</tr>
<tr>
<td>hour</td>
<td>小时</td>
</tr>
<tr>
<td>minute</td>
<td>分钟</td>
</tr>
<tr>
<td>second</td>
<td>秒</td>
</tr>
<tr>
<td>week</td>
<td>周</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="built_in">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> &quot;2020-07-29 10:31:10&quot;) <span class="keyword">as</span> y,</span><br><span class="line">    <span class="built_in">extract</span>(<span class="keyword">month</span> <span class="keyword">from</span>  &quot;2020-07-29 10:31:10&quot;) <span class="keyword">as</span> m</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果为：</p>
</blockquote>
<table>
<thead>
<tr>
<th>y</th>
<th>m</th>
</tr>
</thead>
<tbody><tr>
<td>2020</td>
<td>07</td>
</tr>
</tbody></table>
<ol start="3">
<li><strong>date_format() 用法</strong></li>
</ol>
<ul>
<li>参数可选格式：</li>
</ul>
<table>
<thead>
<tr>
<th>主题</th>
<th>格式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>年</td>
<td>%Y</td>
<td>4位数字表示的年</td>
</tr>
<tr>
<td>月</td>
<td>%b</td>
<td>月份对应的英文缩写</td>
</tr>
<tr>
<td>月</td>
<td>%M</td>
<td>月份对应的英文全称</td>
</tr>
<tr>
<td>月</td>
<td>%m</td>
<td>以01-12的形式表示的月</td>
</tr>
<tr>
<td>月</td>
<td>%c</td>
<td>以1-12的形式表示的月</td>
</tr>
<tr>
<td>日</td>
<td>%d</td>
<td>以01-31的形式表示某月中的第几天</td>
</tr>
<tr>
<td>日</td>
<td>%e</td>
<td>以1-31的形式表示某月中的第几天</td>
</tr>
<tr>
<td>日</td>
<td>%D</td>
<td>用th后缀表示某月中的第几天</td>
</tr>
<tr>
<td>日</td>
<td>%j</td>
<td>以001-366的形式表示一年中的第几天</td>
</tr>
<tr>
<td>周</td>
<td>%a</td>
<td>星期几对应的英文缩写</td>
</tr>
<tr>
<td>周</td>
<td>%W</td>
<td>星期几对应的英文全称</td>
</tr>
<tr>
<td>时</td>
<td>%H</td>
<td>以00-23的形式表示的小时</td>
</tr>
<tr>
<td>时</td>
<td>%h</td>
<td>以01-12的形式表示的小时</td>
</tr>
<tr>
<td>分</td>
<td>%i</td>
<td>以00-59的形式表示的分钟</td>
</tr>
<tr>
<td>秒</td>
<td>%S</td>
<td>以00-59的形式表示的秒</td>
</tr>
<tr>
<td>秒</td>
<td>%f</td>
<td>微秒</td>
</tr>
<tr>
<td>时分秒</td>
<td>%T</td>
<td>返回当前时刻的时分秒（hh:mm:ss)</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    date_format(&quot;2020-07-29 10:31:10&quot;, &quot;%Y-%m-%d&quot;)</span><br></pre></td></tr></table></figure>




<ol start="4">
<li><strong>datediff-求留存率</strong><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    hit_date,</span><br><span class="line">    user_account</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    computer_view.data</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">&#x27;2019-04-25&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-05-13&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    btn_information <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>),</span><br><span class="line">a2 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    hit_date,</span><br><span class="line">    user_account</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    computer_view.data</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">&#x27;2019-04-25&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-05-13&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    btn_information <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">a1.hit_date,</span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> a1.user_account) uv,<span class="comment">---一次性求次1日，次3日， 次7日留存，此方法不能计算pv，会造成笛卡尔积</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> datediff(a2.hit_date, a1.hit_date) <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) next_day,</span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> datediff(a2.hit_date, a1.hit_date) <span class="operator">=</span> <span class="number">3</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) three_day,</span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> datediff(a2.hit_date, a1.hit_date) <span class="operator">=</span> <span class="number">7</span> <span class="keyword">then</span> a1.user_account <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) seven_day</span><br><span class="line"><span class="keyword">from</span> a1 <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account <span class="operator">=</span> a2.user_account</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a1.hit_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a1.hit_date</span><br><span class="line">limit <span class="number">100</span></span><br></pre></td></tr></table></figure></li>
</ol>
<!-- - date_add 求留存率

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---步骤1：统计每天的uv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---步骤2： - 统计10-15号每天的次日留存数， 统计次3、7日留存只需将1换为3、7</span></span><br><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        computer_view.data</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        hit_date <span class="keyword">between</span>  <span class="string">&#x27;2018-11-10&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-11-15&#x27;</span></span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">        user_account,</span><br><span class="line">        hit_date</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        computer_view.data</span><br><span class="line">    <span class="keyword">where</span> </span><br><span class="line">        hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-11-10&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-11-25&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    a1.hit_date,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> a1.user_account) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1 <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account <span class="operator">=</span> a2.user_account</span><br><span class="line"><span class="keyword">WHERE</span>   </span><br><span class="line">    a2.hit_date <span class="operator">=</span>  date_add(a1.hit_date, <span class="number">1</span>) </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    a1.hit_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">BY</span></span><br><span class="line">    a1.hit_date <span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- --步骤3：计算留存率</span></span><br></pre></td></tr></table></figure>
<!-- 
- 计算留存率的其他写法-迷神

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 留存sql优化</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span> userid, <span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span> t1.userid,</span><br><span class="line">                t1.statdate</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            table1 t1</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            t1.statdate <span class="operator">=</span> $&#123;上<span class="number">30</span>天日期&#125;</span><br><span class="line">            <span class="keyword">and</span> t1.statdate <span class="operator">&lt;=</span> $&#123;上一天日期&#125;</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">            t1.userid,</span><br><span class="line">            t1.statdate</span><br><span class="line">        ) s1</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        userid</span><br><span class="line">    <span class="keyword">having</span></span><br><span class="line">        <span class="built_in">count</span>(<span class="number">1</span>)  <span class="number">2</span></span><br><span class="line">    ) R1</span><br><span class="line"></span><br><span class="line"><span class="comment">--此sql为一个样例，计算连续跟任意都适用，至于计算第N天，只需要更改下日期过滤条件，变成=$[上N天日期]，=$&#123;上一天日期&#125;。 </span></span><br><span class="line"><span class="comment">--另外，这种方式适合跑当前周期数据，如果跑历史数据，可以写个循环。当然，最暴力还是直接用userid 关联。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--这种写法，更多是针对现在大部分分布式处理平台的特性，尽可能将数据合理均匀分片，每台服务器各自运算自己的，最后汇总。 尽可能少用 count distinct 这种写法，因为无法利用分片的特性。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>留存率的另一种写法-勇哥</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	hit_date,</span><br><span class="line">	user_account,</span><br><span class="line">	<span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> hit_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	apache_computer_view.client_android_log</span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">	hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-04-01&#x27;</span> <span class="keyword">and</span>  <span class="string">&#x27;2020-04-07&#x27;</span></span><br><span class="line">	<span class="keyword">and</span></span><br><span class="line">	btn_navigation  <span class="keyword">like</span> &quot;%查询办理%&quot;</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	hit_date,</span><br><span class="line">    user_account,</span><br><span class="line">    <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> hit_count</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	apache_computer_view.client_android_log</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-04-01&#x27;</span> <span class="keyword">and</span>  <span class="string">&#x27;2020-04-07&#x27;</span></span><br><span class="line">	<span class="keyword">and</span></span><br><span class="line">	btn_navigation  <span class="keyword">like</span> &quot;%查询办理%&quot;</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	a1.hit_date <span class="keyword">as</span> <span class="keyword">one</span>,</span><br><span class="line">	a2.hit_date <span class="keyword">as</span> two,</span><br><span class="line">	datediff(a2.hit_date, a1.hit_date) <span class="keyword">as</span> cha,</span><br><span class="line">	<span class="built_in">count</span>(<span class="keyword">distinct</span> a2.user_account),</span><br><span class="line">	<span class="built_in">sum</span>(a2.hit_count)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1 <span class="keyword">left</span> <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.user_account <span class="operator">=</span> a2.user_account</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    cha <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">​``` <span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> 计算月留存率的简单写法：筛选出在两个月份出现的用户</span><br><span class="line">​```<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (<span class="keyword">select</span> </span><br><span class="line">    user_account,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">month</span> (hit_date)) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">   android_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     hit_date <span class="keyword">between</span> <span class="string">&#x27;2019-03-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-04-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"> user_account</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">  c <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    user_account,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">month</span> (hit_date)) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    ios_log </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">     hit_date <span class="keyword">between</span> <span class="string">&#x27;2019-03-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-04-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"> user_account</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">  c <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">a1</span><br></pre></td></tr></table></figure>



<ol start="5">
<li><p><strong>日期转换</strong></p>
<p>把2020-12-01日期字段改成：2020-12-01 这样的形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from_unixtime(unix_timestamp(hit_date,&#x27;yyyymmdd&#x27;),&#x27;yyyy-mm-dd&#x27;)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="数据分组与透视"><a href="#数据分组与透视" class="headerlink" title="数据分组与透视"></a>数据分组与透视</h2><ol>
<li><p><strong>对分组后的数据进行聚合运算</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>     </span><br><span class="line">    <span class="keyword">year</span>(ymd), </span><br><span class="line">    <span class="built_in">avg</span>(price_close) <span class="comment">--- 对结果进行分类</span></span><br><span class="line"><span class="keyword">from</span>     </span><br><span class="line">    stocks</span><br><span class="line"><span class="keyword">where</span>     </span><br><span class="line">    exchange <span class="operator">=</span> <span class="string">&#x27;nasdaq&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>     </span><br><span class="line">    <span class="keyword">year</span>(ymd)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span>     </span><br><span class="line">    <span class="keyword">year</span>(ymd) <span class="keyword">desc</span>;  <span class="comment">--desc 从高到低排列</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>对聚合后的数据进行条件筛选</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>     </span><br><span class="line">    deparment, </span><br><span class="line">    <span class="built_in">avg</span>(salary) <span class="keyword">as</span> average </span><br><span class="line"><span class="keyword">from</span>      </span><br><span class="line">    salary_info</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>     </span><br><span class="line">    deparment </span><br><span class="line"><span class="keyword">having</span>     </span><br><span class="line">    average <span class="operator">&gt;</span> <span class="number">3000</span><span class="comment">--- having 子句来限制输出结果--- 查找平均工资大于3000的部门</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>having 与 where 的区别：<blockquote>
<p>Where 是一个约束声明，使用Where约束来自数据库的数据，Where是在结果返回之前起作用的，Where中不能使用聚合函数。<br>Having是一个过滤声明，是在查询返回结果集以后对查询结果进行的过滤操作，在Having中可以使用聚合函数。</p>
</blockquote>
</li>
</ul>
<ol start="3">
<li><strong>group_concat()函数</strong><blockquote>
<p>对以下数据进行分组处理</p>
</blockquote>
</li>
</ol>
<table>
<thead>
<tr>
<th>id</th>
<th>score</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>78</td>
</tr>
<tr>
<td>2</td>
<td>52</td>
</tr>
<tr>
<td>1</td>
<td>69</td>
</tr>
<tr>
<td>2</td>
<td>45</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    group_concat(score) <span class="keyword">as</span> g_score</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    tables</span><br></pre></td></tr></table></figure>
<blockquote>
<p>得到结果如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>id</th>
<th>score</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>78,69</td>
</tr>
<tr>
<td>2</td>
<td>52,45</td>
</tr>
</tbody></table>
<ol start="4">
<li><strong>rollup 函数用法</strong></li>
</ol>
<ul>
<li> 需求背景： 求每个省份的销量，然后求每个省份下城市的销量，汇总到一张表中。</li>
</ul>
<blockquote>
<p>写法1：</p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province,</span><br><span class="line">    <span class="keyword">null</span> <span class="keyword">as</span> city,</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">order</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    table_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    province</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province,</span><br><span class="line">    city,</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">order</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    table_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    province,</span><br><span class="line">    city</span><br></pre></td></tr></table></figure>
<blockquote>
<p>写法2：<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	 province, city, <span class="built_in">sum</span>(<span class="keyword">order</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">	 province,city</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">rollup</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>得到结果如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>province</th>
<th>city</th>
<th>sum(order)</th>
</tr>
</thead>
<tbody><tr>
<td>陕西</td>
<td>null</td>
<td>50</td>
</tr>
<tr>
<td>陕西</td>
<td>西安</td>
<td>20</td>
</tr>
<tr>
<td>陕西</td>
<td>渭南</td>
<td>10</td>
</tr>
<tr>
<td>陕西</td>
<td>汉中</td>
<td>20</td>
</tr>
<tr>
<td>北京</td>
<td>北京</td>
<td>24</td>
</tr>
<tr>
<td>null</td>
<td>null</td>
<td>74</td>
</tr>
</tbody></table>
<ol start="5">
<li>数据透视表</li>
</ol>
<ul>
<li> 将下表进行按照年份和季度进行透视汇总</li>
</ul>
<table>
<thead>
<tr>
<th>年</th>
<th>季度</th>
<th>销售量</th>
</tr>
</thead>
<tbody><tr>
<td>1991</td>
<td>1</td>
<td>11</td>
</tr>
<tr>
<td>1991</td>
<td>2</td>
<td>12</td>
</tr>
<tr>
<td>1991</td>
<td>3</td>
<td>13</td>
</tr>
<tr>
<td>1991</td>
<td>4</td>
<td>14</td>
</tr>
<tr>
<td>1992</td>
<td>1</td>
<td>21</td>
</tr>
<tr>
<td>1992</td>
<td>2</td>
<td>22</td>
</tr>
<tr>
<td>1992</td>
<td>3</td>
<td>23</td>
</tr>
<tr>
<td>1992</td>
<td>4</td>
<td>24</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	年,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span>  季度 <span class="operator">=</span> <span class="number">1</span> <span class="keyword">then</span> 销售量  <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) 一季度,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span> 季度 <span class="operator">=</span> <span class="number">2</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 二季度,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span> 季度 <span class="operator">=</span> <span class="number">3</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) <span class="keyword">as</span>  三季度,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span> 季度 <span class="operator">=</span> <span class="number">4</span> <span class="keyword">then</span> 销售量 <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) <span class="keyword">as</span> 四季度</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">page </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">年</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">年</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查询结果如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>年</th>
<th>一季度</th>
<th>二季度</th>
<th>三季度</th>
<th>四季度</th>
</tr>
</thead>
<tbody><tr>
<td>1991</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>14</td>
</tr>
<tr>
<td>1992</td>
<td>21</td>
<td>22</td>
<td>23</td>
<td>24</td>
</tr>
</tbody></table>
<ul>
<li>统计各部门男女分别有多少人</li>
</ul>
<table>
<thead>
<tr>
<th>姓名</th>
<th>部门</th>
<th>性别</th>
</tr>
</thead>
<tbody><tr>
<td>甲</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>乙</td>
<td>A</td>
<td>男</td>
</tr>
<tr>
<td>丙</td>
<td>B</td>
<td>女</td>
</tr>
<tr>
<td>丁</td>
<td>A</td>
<td>女</td>
</tr>
<tr>
<td>张</td>
<td>B</td>
<td>男</td>
</tr>
<tr>
<td>赵</td>
<td>B</td>
<td>女</td>
</tr>
</tbody></table>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="string">&#x27;部门&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span> 性别 <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">then</span> <span class="number">1</span>  <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) <span class="keyword">as</span> <span class="string">&#x27;男&#x27;</span>,</span><br><span class="line"><span class="built_in">sum</span>( <span class="keyword">case</span> <span class="keyword">when</span> 性别 <span class="operator">=</span> <span class="string">&#x27;女&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="keyword">null</span> <span class="keyword">end</span> ) <span class="keyword">as</span>  <span class="string">&#x27;女&#x27;</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">table1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"><span class="string">&#x27;部门&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>得到结果如下:</p>
</blockquote>
<table>
<thead>
<tr>
<th>部门</th>
<th>男</th>
<th>女</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>B</td>
<td>1</td>
<td>2</td>
</tr>
</tbody></table>
<!-- `rollup` 函数输出结果，不会有 `null, null, null, city` 值， 和 `cube` 的区别在于： `cube` 是维度更细的统计，假设数据有 `n` 个维度， 那么 `rollup` 会有 `n` 个聚合，`cube` 会有 `2n` 个聚合。 -->


 <!-- >解法1：分别写5个sql，这种方法太低效了， 还需要在excel中进行合并。
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(order_id)  <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="comment">---全国成交量</span></span><br><span class="line"><span class="keyword">select</span> area, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area<span class="comment">--大区成交量</span></span><br><span class="line"><span class="keyword">select</span> area, province, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area, province<span class="comment">--省成交量</span></span><br><span class="line"><span class="keyword">select</span> area, province, city, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span>  area, province, city<span class="comment">---城市成交量</span></span><br><span class="line"><span class="keyword">select</span> area, province, city, shop, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area, province, city, shop<span class="comment">--店铺成交量</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>解法2：通过 union 和 union all 对查询结果进行纵向合并—sql中有很多 null, 这是因为 union all 拼接的两个表的列数需要相等。</p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="built_in">count</span>(order_id)  <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="comment">---全国成交量</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,<span class="keyword">null</span>,  area, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area<span class="comment">--大区成交量</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>, <span class="keyword">null</span>,<span class="keyword">null</span>,  area, province, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area, province<span class="comment">--省成交量</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>, <span class="keyword">null</span>, area, province, city, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span>  area, province, city<span class="comment">---城市成交量</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,  area, province, city, shop, <span class="built_in">count</span>(order_id) <span class="keyword">as</span> sales <span class="keyword">from</span> table1 <span class="keyword">group</span> <span class="keyword">by</span> area, province, city, shop <span class="comment">--店铺成交量</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="https://i.loli.net/2019/06/10/5cfe6c219ca3f57084.png" alt="sql结果"></p>
<p>解法3：用<code>grouping sets</code>来根据不同维度组合进行聚合</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">null</span>, area, province, city, shop</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">	<span class="keyword">null</span>, area, province, city, shop</span><br><span class="line"><span class="keyword">grouping</span> <span class="keyword">set</span></span><br><span class="line">	( <span class="keyword">null</span>, (<span class="keyword">null</span>, area), (<span class="keyword">null</span>, area,province), (<span class="keyword">null</span>, area, province, city), (<span class="keyword">null</span>,area, province, city,shop) )</span><br></pre></td></tr></table></figure>

<p>得到结果与利用 <code>union all</code>拼接结果相同。<code>group by</code>后面的字段表示要分组聚合的全部字段， <code>grouping sets</code>后面为 <code>group by</code> 后面各种字段的组合。 –&gt;</p>
<!-- 
解法4：`cube`函数， 对`group by`的维度的所有组合进行聚合。

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	 area, province, city, shop</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">	 area, province, city, shop</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">cube</span></span><br></pre></td></tr></table></figure>

<p><code>cube</code> 会先对全部数据进行聚合，即 <code>null,null,null,null</code> 进行聚合，(只是不像解法3一样，显示null列， 如需显示只要加入null即可） 然后对 <code>area, null, null, null</code> 进行聚合，……. –&gt;</p>
<hr>
<h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>定义</th>
</tr>
</thead>
<tbody><tr>
<td>over()</td>
<td>指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变化而变化</td>
</tr>
<tr>
<td><strong>常跟的函数</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td>current row</td>
<td>当前行</td>
</tr>
<tr>
<td>n preceding</td>
<td>往前n行数据</td>
</tr>
<tr>
<td>n following</td>
<td>往后n行数据</td>
</tr>
<tr>
<td>unbounded</td>
<td>起点</td>
</tr>
<tr>
<td>uvbounded preceding</td>
<td>表示从前面的起点开始</td>
</tr>
<tr>
<td>unbounded following</td>
<td>表示到后面的终点</td>
</tr>
<tr>
<td>lag(col, n)</td>
<td>往前第n行数据</td>
</tr>
<tr>
<td>lead(col, n)</td>
<td>往后第n行数据</td>
</tr>
<tr>
<td>ntile(n)</td>
<td>把有序分区中的行分发到指定数据的组中， 各个组有编号，编号从1开始，ntile返回此行所属组的编号</td>
</tr>
<tr>
<td>first_value()</td>
<td>返回组中数据窗口的第一个值</td>
</tr>
<tr>
<td>last_value()</td>
<td>返回组中数据窗口的最后一个值</td>
</tr>
</tbody></table>
<ol>
<li><strong>聚合函数+over()</strong></li>
</ol>
<blockquote>
<p>商业表如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
</tr>
</tbody></table>
<ul>
<li>求每个店铺的每天效率和全部总销量</li>
</ul>
<blockquote>
<p>写法1</p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    shop_name,</span><br><span class="line">    order_date,</span><br><span class="line">    cost,</span><br><span class="line">    (<span class="keyword">select</span> <span class="built_in">sum</span>(cost) <span class="keyword">from</span> business) <span class="keyword">as</span> sum_cost</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
<blockquote>
<p>写法2<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> </span><br><span class="line">    shop_name,</span><br><span class="line">    order_date,</span><br><span class="line">    cost,</span><br><span class="line">    <span class="built_in">sum</span>(cost)<span class="keyword">over</span>() <span class="keyword">as</span> sum_cost</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>得到结果如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
<th>sum_cost</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
<td>150</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
<td>150</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
<td>150</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
<td>150</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
<td>150</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
<td>150</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
<td>150</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
<td>150</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
<td>150</td>
</tr>
</tbody></table>
<ol start="2">
<li><strong>partition by 子句</strong></li>
</ol>
<ul>
<li>查询各店铺日销量明细及各店铺平均每日销量</li>
</ul>
<blockquote>
<p>写法1<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        shop_name,order_name, cost</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">        business</span><br><span class="line">),</span><br><span class="line">a2 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        shop_name,</span><br><span class="line">        <span class="built_in">avg</span>(cost) <span class="keyword">as</span> avg_cost</span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        business</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">        shop_name</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    a1.shop_name,</span><br><span class="line">    a1.order_name,</span><br><span class="line">    a1.cost,</span><br><span class="line">    a2.avg_cost</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    a1 <span class="keyword">left</span> <span class="keyword">join</span> a2 <span class="keyword">on</span> a1.shop_name <span class="operator">=</span> a2.shop_name</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>写法2</p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> </span><br><span class="line">    shop_name,</span><br><span class="line">    order_name,</span><br><span class="line">    cost,</span><br><span class="line">    <span class="built_in">avg</span>(cost)<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop_name) <span class="keyword">as</span> avg_cost</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
<th>age_cost</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
<td>16.7</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
<td>16.7</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
<td>16.7</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
<td>16.7</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
<td>16.7</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
<td>16.7</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
<td>20</td>
</tr>
</tbody></table>
<ol start="3">
<li> order by 子句</li>
</ol>
<ul>
<li>求不同店铺每日明细，及按照日期进行累加<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> </span><br><span class="line">    shop_name,</span><br><span class="line">    order_name,</span><br><span class="line">    cost,</span><br><span class="line">    <span class="built_in">sum</span>(cost)<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop_name <span class="keyword">order</span> <span class="keyword">by</span> order_date)  <span class="keyword">as</span> sum_cost</span><br><span class="line">    <span class="comment">---只根据日期进行累加，不区分店铺。先排序，之后按照顺序，从起到到当前行进行求和</span></span><br><span class="line">    <span class="comment">---sum(cost)over( order by orderdate   rows between unbounded preceding and  current row)</span></span><br><span class="line">    <span class="comment">--- 按照日期进行排序，并将当前日期和前一天、后一天数据求和</span></span><br><span class="line">    <span class="comment">---sum(cost) over(order by  orderdate  rows between 1   preceding  between  1 following ) </span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br><span class="line">    <span class="comment">--- sum没有问题，但是count(distinct user_account) 就不能用这种方法</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果如下：</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
<th>age_cost</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
<td>10</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
<td>35</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
<td>50</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
<td>15</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
<td>40</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
<td>50</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
<td>60</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
<td>60</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
<td>60</td>
</tr>
</tbody></table>
<!-- - 求每个人将按照日期进行累加的消费金额

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">name, </span><br><span class="line"><span class="built_in">sum</span>(cost) <span class="keyword">over</span> ( <span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span>  orderdate  <span class="type">row</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span>) </span><br><span class="line"><span class="keyword">from</span>  business </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">name </span><br></pre></td></tr></table></figure>

<ul>
<li>要将cost按照日期进行倒序累加</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> </span><br><span class="line"><span class="operator">*</span>,</span><br><span class="line"><span class="built_in">sum</span>(cost) <span class="keyword">over</span> ( <span class="keyword">order</span> <span class="keyword">by</span> orderdate <span class="keyword">desc</span> <span class="type">row</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span>)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">business </span><br><span class="line">​``` <span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> <span class="built_in">ntile</span>()函数</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> <span class="operator">*</span><span class="operator">*</span>[ntile函数详解](https:<span class="operator">/</span><span class="operator">/</span>www.cnblogs.com<span class="operator">/</span><span class="number">52</span>xf<span class="operator">/</span>p<span class="operator">/</span><span class="number">4209211.</span>html)<span class="operator">*</span><span class="operator">*</span> </span><br><span class="line"><span class="operator">&gt;</span> ntile函数可以将有序数据，根据指定的组数进行分组处理。 编号从<span class="number">1</span>开始，对于每一行，ntile将返回此行所属的组编号。 ntile函数的分组依据：</span><br><span class="line"><span class="operator">&gt;</span><span class="number">1.</span> 检查能不能对所有满足条件的记录进行平均分组，若能则直接平均分配完成分组。</span><br><span class="line"><span class="operator">&gt;</span><span class="number">2.</span> 若不能，则会先分出一个组，此组个数为（总个数<span class="operator">/</span>总组数）<span class="operator">+</span><span class="number">1</span>。</span><br><span class="line"><span class="operator">&gt;</span><span class="number">3.</span> 分配之后系统会继续比较余下的记录数与未分配的组数能不能进行平均分配，若不能，则根据上面条件再分配。</span><br><span class="line"><span class="operator">&gt;</span><span class="operator">-</span> 例如：将<span class="number">6</span>个记录分为<span class="number">4</span>组， 不能平均分配则，第一组记录数为 （<span class="number">6</span><span class="operator">/</span><span class="number">4</span>)<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> <span class="number">2</span>条记录。剩余<span class="number">4</span>条记录分为<span class="number">3</span>组，不能平均分配，则第二组记录数为（<span class="number">4</span><span class="operator">/</span><span class="number">3</span>)<span class="operator">+</span><span class="number">1</span><span class="operator">=</span><span class="number">2</span>条记录。剩余<span class="number">2</span>条记录分为<span class="number">2</span>组，则剩余<span class="number">2</span>组各<span class="number">1</span>条记录。</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span> 将表分成三组</span><br><span class="line">​```<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="keyword">select</span> </span><br><span class="line">    shop_name,</span><br><span class="line">    order_name,</span><br><span class="line">    cost,</span><br><span class="line">    <span class="built_in">ntile</span>(<span class="number">3</span>)<span class="keyword">over</span> <span class="keyword">as</span> cut_group</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>
<blockquote>
<p>输出结果如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
<th>cut_group</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
<td>1</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
<td>1</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
<td>1</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
<td>2</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
<td>2</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
<td>3</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
<td>3</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
<td>3</td>
</tr>
</tbody></table>
<ul>
<li>将各个店铺销量进行升序排序后进行内部切分<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">     <span class="keyword">select</span> </span><br><span class="line">    shop_name,</span><br><span class="line">    order_name,</span><br><span class="line">    cost,</span><br><span class="line">    <span class="built_in">ntile</span>(<span class="number">3</span>)<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop_name <span class="keyword">order</span> <span class="keyword">by</span> cost) <span class="keyword">as</span> cut_group</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>输出结果如下</p>
</blockquote>
<table>
<thead>
<tr>
<th>shop_name</th>
<th>order_date</th>
<th>cost</th>
<th>age_cost</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>2017-01-01</td>
<td>10</td>
<td>1</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-02</td>
<td>25</td>
<td>2</td>
</tr>
<tr>
<td>A</td>
<td>2017-01-03</td>
<td>15</td>
<td>3</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-01</td>
<td>15</td>
<td>1</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-02</td>
<td>25</td>
<td>2</td>
</tr>
<tr>
<td>B</td>
<td>2017-01-03</td>
<td>10</td>
<td>3</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-01</td>
<td>20</td>
<td>1</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-02</td>
<td>20</td>
<td>2</td>
</tr>
<tr>
<td>C</td>
<td>2017-01-03</td>
<td>20</td>
<td>3</td>
</tr>
</tbody></table>
<ul>
<li>查询前50%时间的订单信息<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  <span class="operator">*</span>  <span class="keyword">from</span> </span><br><span class="line">	(<span class="keyword">select</span> </span><br><span class="line">		name,</span><br><span class="line">		orderdate,</span><br><span class="line">		cost,</span><br><span class="line">		<span class="built_in">ntile</span>(<span class="number">1</span>)<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) <span class="keyword">as</span> git</span><br><span class="line">		<span class="keyword">from</span> </span><br><span class="line">		business)</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">git <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="5">
<li><strong>排序函数</strong></li>
</ol>
<ul>
<li>SQl 中用于排序的函数有：rank、dense_rank、row_number、ntile函数,其语法为：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rank</span>() <span class="keyword">over</span> ( <span class="keyword">partition</span> <span class="keyword">by</span> A <span class="keyword">ORDER</span> <span class="keyword">BY</span> B  <span class="keyword">desc</span> )   <span class="comment">---1、1、3</span></span><br><span class="line"><span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> A <span class="keyword">order</span> <span class="keyword">by</span> B <span class="keyword">desc</span>)  <span class="comment">--- 1、1、2</span></span><br><span class="line"><span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> A <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">desc</span>)    <span class="comment">--1、2、3</span></span><br><span class="line"><span class="built_in">ntile</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> A <span class="keyword">ORDER</span> <span class="keyword">BY</span> b <span class="keyword">desc</span>)      <span class="comment">--分组</span></span><br></pre></td></tr></table></figure>

<ul>
<li>找出各省点击人数Top10的按钮？<blockquote>
<ol>
<li>取出 省份、按钮和 uv;</li>
<li>各省分组内，按照uv进行从大到小排序，并输出一列排序序号;</li>
<li>根据排序序号，取出排序前10的按钮和省份。 </li>
</ol>
</blockquote>
</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">province,</span><br><span class="line">nbtn_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">    province,  <span class="comment">--省份</span></span><br><span class="line">    nbtn_name, <span class="comment">--按钮 </span></span><br><span class="line">    uv,        <span class="comment">--uv</span></span><br><span class="line">    <span class="built_in">dense_rank</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> province <span class="keyword">order</span> <span class="keyword">by</span> uv  <span class="keyword">DESC</span>) <span class="keyword">as</span> ran <span class="comment">--排序</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    province,</span><br><span class="line">    nbtn_name,</span><br><span class="line">    <span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    table1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    nbtn_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>  </span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    hit_date <span class="operator">=</span> <span class="string">&#x27;2020-06-01&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    province,</span><br><span class="line">    nbtn_name))</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">ran <span class="keyword">between</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;10&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>求连续3个月活跃的用户数</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">dt,</span><br><span class="line">user_account,</span><br><span class="line"><span class="built_in">dense_rank</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_account <span class="keyword">order</span> <span class="keyword">by</span> dt) <span class="keyword">as</span> raws</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">(<span class="keyword">select</span> </span><br><span class="line">user_account,</span><br><span class="line"><span class="keyword">month</span>(hit_date)  <span class="keyword">as</span> dt </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">table1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-04-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-06-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">user_account, dt) a1</span><br><span class="line">) a2</span><br><span class="line">)</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">a2.raws <span class="operator">=</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ul>
<li>求4月连续7天进行签到的用户数<blockquote>
<ol>
<li>求出手机号和日期，并去重</li>
<li>根据手机号，对日期进行排序，并且日期和排序进行相减</li>
<li>对相减后得到的日期进行统计，并计算数量大于7的用户</li>
<li>对数量大于7的用户进行去重处理</li>
</ol>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	user_account,</span><br><span class="line">	raw,</span><br><span class="line">	<span class="built_in">count</span>(raw) <span class="keyword">as</span> raw_1</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">		<span class="keyword">select</span> </span><br><span class="line">			user_account,</span><br><span class="line">				hit_date,</span><br><span class="line">			date_sub(hit_date, <span class="built_in">row_number</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_account <span class="keyword">order</span> <span class="keyword">by</span> hit_date) )<span class="keyword">as</span> raw</span><br><span class="line">	<span class="keyword">from</span> </span><br><span class="line">		(</span><br><span class="line">		<span class="keyword">select</span></span><br><span class="line">			user_account,</span><br><span class="line">			hit_date</span><br><span class="line">		<span class="keyword">from</span> </span><br><span class="line">			apache_computer_view.client_android_log</span><br><span class="line">		<span class="keyword">where</span> </span><br><span class="line">			hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-04-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-04-31&#x27;</span></span><br><span class="line">		<span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">			user_account,</span><br><span class="line">			hit_date))</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">	user_account,</span><br><span class="line">	raw)</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">raw_1 <span class="operator">&gt;=</span> <span class="number">7</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="6">
<li><strong>lag()和lead()函数</strong></li>
</ol>
<ul>
<li>查询顾客的上次购买时间</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">    <span class="built_in">lag</span>(orderdate,<span class="number">1</span>)<span class="keyword">over</span>( partation <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span>  orderdate)</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure>

<ul>
<li>查询顾客上次购买的时间, 与下次购买时间。相邻两个时间戳如何相减，求时间</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">    <span class="built_in">lag</span>(orderdate, <span class="number">1</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate) <span class="keyword">as</span> up_date,</span><br><span class="line">    <span class="built_in">lead</span>(orderdate, <span class="number">1</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate) <span class="keyword">as</span> downdate</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business </span><br></pre></td></tr></table></figure>

<ol start="7">
<li> <strong>first_value()和last_value函数</strong></li>
</ol>
<ul>
<li>查询用户第一次购买时间和最后一次购买时间<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="operator">*</span>,</span><br><span class="line">    <span class="built_in">first_value</span>(orderdate) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span>  orderdate) <span class="keyword">as</span> first_date,</span><br><span class="line">    <span class="built_in">last_value</span>(orderdate) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate) <span class="keyword">as</span> last_date</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="多表连接"><a href="#多表连接" class="headerlink" title="多表连接"></a>多表连接</h2><ol>
<li><strong>join</strong></li>
</ol>
<blockquote>
<p>Hive中Join的关联键必须在ON ()中指定，不能在Where中指定,ON 子句指定了两个表间数据进行连接的条件。</p>
</blockquote>
<p><img src="https://i.loli.net/2019/06/11/5cffb911ad8e183153.png" alt="join"></p>
<ul>
<li>对于多张表进行连接查询</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (((a <span class="keyword">JOIN</span> b <span class="keyword">ON</span> a.ymd <span class="operator">=</span> b.ymd)</span><br><span class="line">      <span class="keyword">JOIN</span> c <span class="keyword">ON</span> a.ymd <span class="operator">=</span> c.ymd)</span><br><span class="line">      <span class="keyword">join</span> d <span class="keyword">on</span> a.ymd <span class="operator">=</span> d.ymd)</span><br><span class="line">       <span class="comment">---为什么条件内不将表 b 和表 c 进行连接操作， 因为 Hive总是按照从左到右的顺序来执行</span></span><br><span class="line"><span class="keyword">WHERE</span> </span><br><span class="line">    a. symbol <span class="operator">=</span> <span class="string">&#x27;Apple&#x27;</span>  <span class="keyword">AND</span> b.symbol <span class="operator">=</span> <span class="string">&#x27;Ibm&#x27;</span> <span class="keyword">AND</span> c.symbol <span class="operator">=</span> <span class="string">&#x27;Google&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li> <strong>并集：union 与 union all</strong></li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-02&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;</span><br><span class="line">        <span class="keyword">union</span> </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-02&#x27;</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> &quot;%手淘%&quot;)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>

<ul>
<li>union 与 union all 的不同：<blockquote>
<ul>
<li>union, 结果包含所有行， 并删除重复行</li>
<li>unoin all, 结果包含所有行， 但不删除重复行</li>
</ul>
</blockquote>
</li>
</ul>
<ol start="3">
<li> <strong>交集：intersect</strong></li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data1</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-02&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;</span><br><span class="line">        <span class="keyword">intersect</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data1</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-02&#x27;</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> &quot;%手淘%&quot;)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>

<ol start="3">
<li> <strong>差集：except</strong></li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-25&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;</span><br><span class="line">        <span class="keyword">except</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-25&#x27;</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> &quot;%手淘%&quot;)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>



<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><ol>
<li><p>select 子查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    shop_name,</span><br><span class="line">    order_date,</span><br><span class="line">    cost,</span><br><span class="line">    (<span class="keyword">select</span> <span class="built_in">sum</span>(cost) <span class="keyword">from</span> business) <span class="keyword">as</span> sum_cost</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    business</span><br></pre></td></tr></table></figure></li>
<li><p>from 子查询</p>
</li>
</ol>
<ul>
<li>求连续3个月活跃的用户数</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> user_account) <span class="keyword">as</span> uv </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">dt,</span><br><span class="line">user_account,</span><br><span class="line"><span class="built_in">dense_rank</span>()<span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> user_account <span class="keyword">order</span> <span class="keyword">by</span> dt) <span class="keyword">as</span> raws</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">(<span class="keyword">select</span> </span><br><span class="line">user_account,</span><br><span class="line"><span class="keyword">month</span>(hit_date)  <span class="keyword">as</span> dt </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">table1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">hit_date <span class="keyword">between</span> <span class="string">&#x27;2020-04-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2020-06-31&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">user_account, dt) a1</span><br><span class="line">) a2</span><br><span class="line">)</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">a2.raws <span class="operator">=</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>where 子查询</li>
</ol>
<ul>
<li>把平均成绩大于600的同学每次月考成绩提取出来<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    id,</span><br><span class="line">    score,</span><br><span class="line">    month_num</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    table_score</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    id <span class="keyword">in</span> </span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span> </span><br><span class="line">            id, age(score)</span><br><span class="line">        <span class="keyword">from</span> </span><br><span class="line">        table_score</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">            id</span><br><span class="line">        <span class="keyword">having</span></span><br><span class="line">            age(score) <span class="operator">&gt;</span> <span class="number">600</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>with 临时表</li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-25&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;</span><br><span class="line">        <span class="keyword">except</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-25&#x27;</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> &quot;%手淘%&quot;)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br></pre></td></tr></table></figure>







<h2 id="Hive避免数据倾斜"><a href="#Hive避免数据倾斜" class="headerlink" title="Hive避免数据倾斜"></a>Hive避免数据倾斜</h2><blockquote>
<ul>
<li>数据倾斜：当我们在Hive上进行查询时，因为数据的分散度不够， 导致大量数据集中在一台或者几台服务器上， 导致数据的计算速度远远低于平均计算速度， 计算过程特别耗时。</li>
<li>数据倾斜的表现：任务进度长时间维持在99%，查看任务监控页面，发现只有少量子任务未完成。</li>
</ul>
</blockquote>
<ol>
<li><strong>小表Join大表</strong></li>
</ol>
<ul>
<li>Hive 会假定查询中最后一个表是最大的表， 在对每行记录进行连续操作时， 它会尝试将其他表缓存起来，然后扫描最后那个表进行计算。因此，我们在查询时，要保证连续查询中的表的大小从左到右依次是增加的。<blockquote>
<ul>
<li>假如，在 a, b 两个表中，b表最小， 则 写sql时需让b表在左，a表在右：</li>
</ul>
</blockquote>
</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> b.ymd <span class="operator">=</span> a.ymd <span class="keyword">AND</span> b.symbol <span class="operator">=</span> a.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.symbol <span class="operator">=</span> <span class="string">&#x27;APPLE&#x27;</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="comment">/*+3`&#x27;LKLLGFG Streamtable(a)*/</span> a.price_close, b.price_close<span class="comment">---Hive支持使用/*+STREAMTALBE*/语法指定哪张表是大表， 不需要排序</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    a <span class="keyword">JOIN</span> B <span class="keyword">on</span> a.ymd <span class="operator">=</span> b.ymd <span class="keyword">AND</span> a.symbol <span class="operator">=</span> b.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.symbol <span class="operator">=</span> <span class="string">&#x27;Apple&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li> <strong>大表JOIN大表</strong></li>
</ol>
<ul>
<li> 空key过滤 <blockquote>
<p>有时join超时是因为某些key对应的数据太多，而相同key对应的数据都会发送到相同的reducer上，从而导致内存不够。此时我们应该仔细分析这些异常的key，很多情况下，这些key对应的数据是异常数据，我们需要在sql语句中进行过滤。</p>
</blockquote>
</li>
</ul>
<ul>
<li> 空key转换 <blockquote>
<ul>
<li>有时虽然某个key为空对应的数据很多，但是相应的数据不是异常数据，必须要包含在join的结果中，此时我们可以表a中key为空的字段赋一个随机值，是的数据随机均匀地分布到不同的reducer上。</li>
<li>把空值的 key 变成一个字符串加上随机数，就能把倾斜的数据分到不同的 reduce 上 ,解决数据倾斜问题。</li>
</ul>
</blockquote>
</li>
</ul>
<ol start="3">
<li> <strong>count(distinct) 去重统计</strong></li>
</ol>
<ul>
<li>数据量大时，由于count distinct 操作需要用一个 reduce task 来完成， 这一个reduce 需要处理的数据量太大，会导致整个job很难完成，一般 count distinct 使用先group by 再 count的方式替换。</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> bigtable</span><br></pre></td></tr></table></figure>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> (<span class="keyword">select</span> id <span class="keyword">from</span> bigtable <span class="keyword">group</span> <span class="keyword">by</span> id) a</span><br></pre></td></tr></table></figure>
<ol start="4">
<li> <strong>避免笛卡尔积</strong></li>
</ol>
<p> 尽量避免产生笛卡尔积，如join时不加on条件，或无效的on条件。hive只能使用1个reducer来完成笛卡尔积</p>
<ol start="5">
<li> <strong>行列过滤</strong></li>
</ol>
<ul>
<li>列处理： 在查询中， 避免使用 select *, 使用条件限制取需要的列。</li>
<li> 行处理： 在分区剪裁中，当使用join外关联时，如果将副表的过滤条件写在where后面，那么就会先全表关联，之后再过滤, 这样会耗费资源。</li>
</ul>
<blockquote>
<p>优化前后<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> o.id <span class="keyword">from</span> bigtable b </span><br><span class="line"><span class="keyword">join</span> ori o on.id <span class="operator">=</span> b.id </span><br><span class="line"><span class="keyword">where</span> o.id <span class="operator">&lt;=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure></p>
</blockquote>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b.id <span class="keyword">from</span> bigtable b</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> id <span class="keyword">from</span> ori <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">10</span>) o <span class="keyword">on</span> b.id <span class="operator">=</span> o.id)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>优化前后</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> b.ymd <span class="operator">=</span> a.ymd <span class="keyword">AND</span> b.symbol <span class="operator">=</span> a.symbol</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    s.symbol <span class="operator">=</span> <span class="string">&#x27;APPLE&#x27;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.price_close, b.price_close</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    b <span class="keyword">JOIN</span> a <span class="keyword">ON</span> ( b.ymd <span class="operator">=</span> a.ymd <span class="keyword">AND</span> b.symbol <span class="operator">=</span> a.symbol <span class="keyword">and</span> s.symbol <span class="operator">=</span> <span class="string">&#x27;APPLE&#x27;</span>  <span class="comment">--正确的写法是将 where 条件写在 on 后面</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li> <strong>union all 子查询避免中使用 group by等</strong></li>
</ol>
<ul>
<li>union all 子查询避免中使用 group by【替换 count(distinct) 除外】、count(distinct)、max、min等。</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a1 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-13&#x27;</span></span><br><span class="line">            <span class="keyword">and</span></span><br><span class="line">            nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;</span><br><span class="line">        <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_account,</span><br><span class="line">            hit_date</span><br><span class="line">        <span class="keyword">from</span></span><br><span class="line">            data</span><br><span class="line">        <span class="keyword">where</span></span><br><span class="line">            hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-12-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-12-13&#x27;</span></span><br><span class="line">        <span class="keyword">and</span></span><br><span class="line">        nbtn_name <span class="keyword">like</span> &quot;%支付宝%&quot;)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    hit_date,</span><br><span class="line">    <span class="built_in">count</span>(user_account) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    hit_date</span><br></pre></td></tr></table></figure>

<ol start="7">
<li> <strong>避免不同数据类型进行关联</strong></li>
</ol>
<ul>
<li>使用CAST函数对数据类型进行转换，语法为cast(value AS TYPE)</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    a.price_close,</span><br><span class="line">    b.price_close</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    a <span class="keyword">join</span> b  <span class="keyword">on</span> a.user_id <span class="operator">=</span> <span class="built_in">cast</span>(b.user_id <span class="keyword">as</span> string)</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    hit_date <span class="keyword">between</span> <span class="string">&#x27;2018-11-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2018-11-02&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> </span><br><span class="line">    a.symbol <span class="operator">=</span> <span class="string">&#x27;apple&#x27;</span></span><br></pre></td></tr></table></figure>

<!-- Hive的查询注意事项以及优化总结： 1. 尽量尽早过滤数据，减少每个阶段的数据量。对于分区表要加分区，同时只选择需要使用到的字段

1. 对历史库的计算经验
2. 尽量原子化操作，尽量避免一个SQL包含复杂逻辑，可以使用中间表来完成复杂的逻辑
3. join操作 小表要注意放在join的左边，否则会引起磁盘和内存的大量消耗
4. 如果union all的部分个数大于2，或者每个union部分数据量大，应该拆成多个insert into语句，实际测试过程中，执行时间能提升50% -->

<h2 id="用python脚本连接数据库"><a href="#用python脚本连接数据库" class="headerlink" title="用python脚本连接数据库"></a>用python脚本连接数据库</h2><!-- 作为一名数据分析师，日报、周报、月报数据一个也不能少。 相应的， 就要在数据库中提取大量的数据， 并处理大量的Excel表格。

在提取和处理数据的过程中， 对于一些重复性的劳动， 写个Python脚本来实现半自动化， 能够大幅提高自己的工作效率。 以下是自己工作中的一点总结经验。 -->


<!-- 对于数据库的ip地址，用户名，密码等， 如果不清楚，或数据库连接不上， 需要和开发人员对接 -->
<ol>
<li><p>首先， 用Python连接数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyhive <span class="keyword">import</span> hive </span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">conn = hive.Connection(host=<span class="string">&#x27;ip地址&#x27;</span>, port=<span class="number">10000</span>, username=<span class="string">&#x27;用户名&#x27;</span>, database = <span class="string">&#x27;default&#x27;</span>, auth=<span class="string">&#x27;NOSASL&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()<span class="comment"># 获得连接的游标</span></span><br></pre></td></tr></table></figure></li>
<li><p>设置开始和结束时间 可以用python中的time函数设置时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startdate = <span class="string">&#x27;2018-09-01&#x27;</span></span><br><span class="line">enddate   = <span class="string">&#x27;2018-09-19&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>用Python中的format函数将日期传入{}中</p>
 <!-- * python中写sql脚本时， 需要用\来进行换行符的转换, \后面不能有空格。 --></li>
</ol>
<ul>
<li>日期用两个{}来代替， 用format函数将开始日期与结束日期传入<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sql_jifenxinxi_an = <span class="string">&quot;&quot;&quot;select </span></span><br><span class="line"><span class="string">    count(distinct user_account) as uv, </span></span><br><span class="line"><span class="string">    count(1) as pv </span></span><br><span class="line"><span class="string">from </span></span><br><span class="line"><span class="string">    computer_view.data </span></span><br><span class="line"><span class="string">where </span></span><br><span class="line"><span class="string">    hit_date between &quot;&#123;&#125;&quot; and &quot;&#123;&#125;&quot; </span></span><br><span class="line"><span class="string">    and </span></span><br><span class="line"><span class="string">    (btn_position like &quot;服务-查询-积分信息%&quot; </span></span><br><span class="line"><span class="string">    or </span></span><br><span class="line"><span class="string">    btn_home = &quot;积分-扇形左&quot; </span></span><br><span class="line"><span class="string">    ) </span></span><br><span class="line"><span class="string">limit 1000&quot;&quot;&quot;</span>.<span class="built_in">format</span>(startdate,enddate)</span><br><span class="line"><span class="comment"># format 插入时间</span></span><br><span class="line">cursor.execute(sql_jifenxinxi_an)</span><br><span class="line"><span class="comment"># 运行此语句</span></span><br><span class="line">cursor.fetchall()</span><br><span class="line"><span class="comment">#fetchall():接收全部的返回结果行.</span></span><br></pre></td></tr></table></figure>
<!-- 
我们可以按照这个格式写工作中需要运行的多个SQL语句。 这样， 当脚本运行的时候， 我们可以腾出时间来去干其他工作， 等过一段时间，所有的SQL语句都跑完了， 我们再进行统一的整理。 --></li>
</ul>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Xw5DOHHGh838w8YXT9lO5g">讲讲 group 的plus版-张俊红</a></li>
<li>《对比excel,轻松学sql数据分析》</li>
<li>hive入门-视频课程</li>
</ol>
<iframe width="560" height="315" src="https://www.youtube.com/embed/9otkcuic-2o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">张宇</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2020/06/02/2021-02-24-%E6%8A%80%E8%83%BD-Hive-SQL%E5%AD%A6%E4%B9%A0/">http://example.com/2020/06/02/2021-02-24-%E6%8A%80%E8%83%BD-Hive-SQL%E5%AD%A6%E4%B9%A0/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">张宇</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/SQL/">
                                    <span class="chip bg-color">SQL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2020/06/03/2020-09-13-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%88%86%E6%9E%90%E6%A8%A1%E5%9E%8B/">
                    <div class="card-image">
                        
                        <img src="https://www.madewill.com/wp-content/uploads/2020/03/%E6%80%9D%E7%BB%B4%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%A1%86%E6%9E%B6.jpg" class="responsive-img" alt="常用的分析思维模型与方法">
                        
                        <span class="card-title">常用的分析思维模型与方法</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            分析思维
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-06-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B4/" class="post-category">
                                    分析思维
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%88%86%E6%9E%90%E6%80%9D%E7%BB%B4/">
                        <span class="chip bg-color">分析思维</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/01/2020-08-12-%E6%8A%80%E8%83%BD-Python-pandas%E5%BA%93%E5%AD%A6%E4%B9%A0/">
                    <div class="card-image">
                        
                        <img src="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2743748018,437360056&fm=26&gp=0.jpg" class="responsive-img" alt="Python-Pandas库学习">
                        
                        <span class="card-title">Python-Pandas库学习</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Python数据处理常见用法
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Python/" class="post-category">
                                    Python
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Python/">
                        <span class="chip bg-color">Python</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <a href="/about" target="_blank">John Doe</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
